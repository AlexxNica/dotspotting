<script type="text/javascript">
{literal}

function draw_map_polymaps(lat, lon){

	var po = org.polymaps;
	var svg = po.svg("svg");

	var div = document.getElementById("map");
	div.appendChild(svg);

	var map = po.map();
	map.container(svg);

	map.add(po.interact());

	var url = po.url("http://{S}tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/998/256/{Z}/{X}/{Y}.png");
	url.hosts(["a.", "b.", "c.", ""]);

	var tileset = po.image();
	tileset.url(url);

	map.add(tileset);

	map.center({lat: lat, lon: lon});

	// TO DO:
	// colour the dots based on privacy
	// make the dots click-able

	var points = po.geoJson();

	points.features([{
		'geometry': {
			'type': 'Point',
			'coordinates': [ lon, lat ],
		}
	}]);

	points.on("load", po.stylist().attr("r", 5));
	map.add(points);
}

function draw_map_modestmaps(lat, lon){

	var mm = com.modestmaps;
	var zoom = 15;

	var template = 'http://a.tile.cloudmade.com/1a1b06b230af4efdbb989ea99e9841af/998/256/{Z}/{X}/{Y}.png';
	var provider = new mm.TemplatedMapProvider(template);

	var dims = undefined;
	var handlers = undefined;

	var map = new mm.Map('map', provider, dims, handlers);
	var loc = new mm.Location(lat, lon);
    	map.setCenterZoom(loc, zoom);

	// see how this is different than what we pass
	// to polymaps? that's a known-known and today
	// it is a problem that is dressed in hairy yak
	// clothes...it should be sorted out though.
	// (20101028/straup)

	var markers = new mm.Markers(map);
	markers.drawPoints([[lat, lon]]);
}

function draw_map (lat, lon){

	if (canhas_polymaps){
		draw_map_polymaps(lat, lon);
		return;
	}

	draw_map_modestmaps(lat, lon);
}

{/literal}

var lat = {$dot.latitude|escape};
var lon = {$dot.longitude|escape};

draw_map(lat, lon);

</script>
