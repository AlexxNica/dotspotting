(function(PM){if(!org)var org={};if(!org.polymaps)org.polymaps={};PM.TouchHandler=function(){}
PM.TouchHandler.prototype={init:function(map,cont){this.map=map;this.container=cont;this.addEvent(container,'touchstart',this.getDoubleTap());this.addEvent(container,'touchstart',this.getTouchStart());this.addEvent(container,'gesturestart',this.getGestureStart());},gestureStart:null,gestureChange:null,gestureCenter:null,gestureEnd:null,startCenter:null,startScale:undefined,startZoom:undefined,getGestureStart:function(){if(!this.gestureStart){var theHandler=this;this.gestureStart=function(e){theHandler.addEvent(theHandler.container,'touchmove',theHandler.getGestureCenter());theHandler.addEvent(theHandler.container,'gesturechange',theHandler.getGestureChange());theHandler.addEvent(theHandler.container,'gestureend',theHandler.getGestureEnd());theHandler.startScale=e.scale;theHandler.startZoom=theHandler.map.zoom();return theHandler.cancelEvent(e);}}
return this.gestureStart;},getGestureCenter:function(){if(!this.gestureCenter){var theHandler=this;this.gestureCenter=function(e){if(e.touches.length==2){var centerX=(e.touches[0].pageX+e.touches[1].pageX)/2.0;var centerY=(e.touches[0].pageY+e.touches[1].pageY)/2.0;theHandler.startCenter={x:centerX,y:centerY};}}}
return this.gestureCenter;},getGestureChange:function(){if(!this.gestureChange){var theHandler=this;this.gestureChange=function(e){if(theHandler.startScale!==undefined&&theHandler.startZoom!==undefined){var scaleFactor=e.scale/theHandler.startScale;var zoomFactor=Math.log(scaleFactor)/Math.log(2);zoomFactor=Math.round(zoomFactor);if(zoomFactor!=0&&theHandler.startCenter){var currentZoom=theHandler.map.zoom();var targetZoom=theHandler.startZoom+zoomFactor;theHandler.map.zoomBy(targetZoom-currentZoom,theHandler.startCenter);}}
return theHandler.cancelEvent(e);}}
return this.gestureChange;},getGestureEnd:function(){if(!this.gestureEnd){var theHandler=this;this.gestureEnd=function(e){theHandler.removeEvent(theHandler.container,'gesturechange',theHandler.getGestureChange());theHandler.removeEvent(theHandler.container,'touchmove',theHandler.getGestureCenter());theHandler.removeEvent(theHandler.container,'gestureend',theHandler.getGestureEnd());theHandler.startCenter=null;theHandler.startScale=undefined;theHandler.startZoom=undefined;return theHandler.cancelEvent(e);}}
return this.gestureEnd;},touchStartHandler:null,getTouchStart:function(){if(!this.touchStartHandler){var theHandler=this;this.touchStartHandler=function(e){if(e.touches.length==1){theHandler.addEvent(document,'touchcancel',theHandler.getTouchEnd());theHandler.addEvent(document,'touchend',theHandler.getTouchEnd());theHandler.addEvent(document,'touchmove',theHandler.getTouchMove());theHandler.prevTouch={x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY};}
return theHandler.cancelEvent(e);};}
return this.touchStartHandler;},touchMoveHandler:null,getTouchMove:function(){if(!this.touchMoveHandler){var theHandler=this;this.touchMoveHandler=function(e){if(theHandler.prevTouch&&e.touches.length==1){theHandler.map.panBy({x:e.touches[0].pageX-theHandler.prevTouch.x,y:e.touches[0].pageY-theHandler.prevTouch.y});theHandler.prevTouch.x=e.touches[0].pageX;theHandler.prevTouch.y=e.touches[0].pageY;}
return theHandler.cancelEvent(e);};}
return this.touchMoveHandler;},touchEndHandler:null,getTouchEnd:function(){if(!this.touchEndHandler){var theHandler=this;this.touchEndHandler=function(e){if(theHandler.prevTouch&&e.touches.length==0){theHandler.removeEvent(document,'touchend',theHandler.getTouchEnd());theHandler.removeEvent(document,'touchcancel',theHandler.getTouchEnd());theHandler.removeEvent(document,'touchmove',theHandler.getTouchMove());theHandler.prevTouch=null;}
return theHandler.cancelEvent(e);};}
return this.touchEndHandler;},doubleTapHandler:null,getDoubleTap:function(){if(!this.doubleTapHandler){var theHandler=this,prevPoint=null,dubTap=false;prevTime=0;function distsq(t1,t2){return Math.sqrt(Math.pow(t1.x-t2.x,2)+Math.pow(t1.y-t2.y,2));}
this.doubleTapHandler=function(e){if(e.touches.length==1){var point={x:e.touches[0].pageX,y:e.touches[0].pageY};if(prevPoint){var dist=distsq(prevPoint,point),dt=new Date().getTime()-prevTime;if(dist<50&&dt<200){var z=theHandler.map.zoom();z=1-z+Math.floor(z);theHandler.map.zoomBy(z,point);dubTap=true;}}
prevPoint=point;prevTime=new Date().getTime();}};}
return this.doubleTapHandler;},addEvent:function(obj,type,fn){if(obj.attachEvent){obj['e'+type+fn]=fn;obj[type+fn]=function(){obj['e'+type+fn](window.event);};obj.attachEvent('on'+type,obj[type+fn]);}
else{obj.addEventListener(type,fn,false);}},removeEvent:function(obj,type,fn){if(obj.detachEvent){obj.detachEvent('on'+type,obj[type+fn]);obj[type+fn]=null;}
else{obj.removeEventListener(type,fn,false);}},cancelEvent:function(e){e.cancelBubble=true;e.cancel=true;e.returnValue=false;if(e.stopPropagation){e.stopPropagation();}
if(e.preventDefault){e.preventDefault();}
return false;}};})(org.polymaps);