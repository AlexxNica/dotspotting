(function(po){po.touch=function(){var touch={},map,container,prevTouch=null,gestureStart=null,gestureChange=null,gestureCenter=null,gestureEnd=null,touchStartHandler=null,touchMoveHandler=null,touchEndHandler=null,doubleTapHandler=null,startCenter=null,startScale=undefined,startZoom=undefined;function cancelEvent(e){e.cancelBubble=true;e.cancel=true;e.returnValue=false;if(e.stopPropagation){e.stopPropagation();}
if(e.preventDefault){e.preventDefault();}
return false;}
function getGestureStart(){if(!this.gestureStart){this.gestureStart=function(e){container.addEventListener('touchmove',getGestureCenter(),false);container.addEventListener('gesturechange',getGestureChange(),false);container.addEventListener('gestureend',getGestureEnd(),false);startScale=e.scale;startZoom=map.zoom();return cancelEvent(e);}}
return this.gestureStart;}
function getGestureCenter(){if(!this.gestureCenter){this.gestureCenter=function(e){if(e.touches.length==2){var centerX=(e.touches[0].pageX+e.touches[1].pageX)/2.0;var centerY=(e.touches[0].pageY+e.touches[1].pageY)/2.0;startCenter={x:centerX,y:centerY};}}}
return this.gestureCenter;}
function getGestureChange(){if(!this.gestureChange){this.gestureChange=function(e){if(startScale!==undefined&&startZoom!==undefined){var scaleFactor=e.scale/startScale;var zoomFactor=Math.log(scaleFactor)/Math.log(2);zoomFactor=Math.round(zoomFactor);if(zoomFactor!=0&&startCenter){var currentZoom=map.zoom();var targetZoom=startZoom+zoomFactor;map.zoomBy(targetZoom-currentZoom,startCenter);}}
return cancelEvent(e);}}
return this.gestureChange;}
function getGestureEnd(){if(!this.gestureEnd){this.gestureEnd=function(e){container.removeEventListener('touchmove',getGestureCenter(),false);container.removeEventListener('gesturechange',getGestureChange(),false);container.removeEventListener('gestureend',getGestureEnd(),false);startCenter=null;startScale=undefined;startZoom=undefined;return cancelEvent(e);}}
return this.gestureEnd;}
function getTouchStart(){if(!this.touchStartHandler){this.touchStartHandler=function(e){if(e.touches.length==1){container.addEventListener('touchend',getTouchEnd(),false);container.addEventListener('touchcancel',getTouchEnd(),false);container.addEventListener('touchmove',getTouchMove(),false);prevTouch={x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY};}};}
return this.touchStartHandler;}
function getTouchMove(){if(!this.touchMoveHandler){this.touchMoveHandler=function(e){if(prevTouch&&e.touches.length==1){map.panBy({x:e.touches[0].pageX-prevTouch.x,y:e.touches[0].pageY-prevTouch.y});prevTouch.x=e.touches[0].pageX;prevTouch.y=e.touches[0].pageY;}
return cancelEvent(e);};}
return this.touchMoveHandler;}
function getTouchEnd(){if(!this.touchEndHandler){this.touchEndHandler=function(e){if(prevTouch&&e.touches.length==0){container.removeEventListener('touchend',getTouchEnd(),false);container.removeEventListener('touchcancel',getTouchEnd(),false);container.removeEventListener('touchmove',getTouchMove(),false);prevTouch=null;}
return cancelEvent(e);};}
return this.touchEndHandler;}
function getDoubleTap(){if(!this.doubleTapHandler){var prevPoint=null,prevTime=0;function distsq(t1,t2){return Math.sqrt(Math.pow(t1.x-t2.x,2)+Math.pow(t1.y-t2.y,2));}
this.doubleTapHandler=function(e){if(e.touches.length==1){var point={x:e.touches[0].pageX,y:e.touches[0].pageY};if(prevPoint){var dist=distsq(prevPoint,point),dt=new Date().getTime()-prevTime;if(dist<50&&dt<200){var z=map.zoom();z=1-z+Math.floor(z);map.zoomBy(z,point);}}
prevPoint=point;prevTime=new Date().getTime();}};}
return this.doubleTapHandler;}
touch.map=function(x){if(!arguments.length)return map;if(map){container.removeEventListener('touchstart',getTouchStart(),false);container.removeEventListener('touchstart',getDoubleTap(),false);container.removeEventListener('gesturestart',getGestureStart(),false);container=null;}
if(map=x){container=map.container();container.addEventListener('touchstart',getTouchStart(),false);container.addEventListener('touchstart',getDoubleTap(),false);container.addEventListener('gesturestart',getGestureStart(),false);}
return touch;};return touch;}})(org.polymaps);