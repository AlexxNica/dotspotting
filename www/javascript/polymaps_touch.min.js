(function(po){po.touch=function(){var touch={},map,container,prevTouch=null,gestureStart=null,gestureChange=null,gestureCenter=null,gestureEnd=null,touchStartHandler=null,touchMoveHandler=null,touchEndHandler=null,doubleTapHandler=null,startCenter=null,startScale=undefined,startZoom=undefined;function addEvent(obj,type,fn){if(obj.attachEvent){obj['e'+type+fn]=fn;obj[type+fn]=function(){obj['e'+type+fn](window.event);};obj.attachEvent('on'+type,obj[type+fn]);}
else{obj.addEventListener(type,fn,false);}}
function removeEvent(obj,type,fn){if(obj.detachEvent){obj.detachEvent('on'+type,obj[type+fn]);obj[type+fn]=null;}
else{obj.removeEventListener(type,fn,false);}}
function cancelEvent(e){e.cancelBubble=true;e.cancel=true;e.returnValue=false;if(e.stopPropagation){e.stopPropagation();}
if(e.preventDefault){e.preventDefault();}
return false;}
function getGestureStart(){if(!this.gestureStart){this.gestureStart=function(e){addEvent(container,'touchmove',getGestureCenter());addEvent(container,'gesturechange',getGestureChange());addEvent(container,'gestureend',getGestureEnd());startScale=e.scale;startZoom=map.zoom();return cancelEvent(e);}}
return this.gestureStart;}
function getGestureCenter(){if(!this.gestureCenter){this.gestureCenter=function(e){if(e.touches.length==2){var centerX=(e.touches[0].pageX+e.touches[1].pageX)/2.0;var centerY=(e.touches[0].pageY+e.touches[1].pageY)/2.0;startCenter={x:centerX,y:centerY};}}}
return this.gestureCenter;}
function getGestureChange(){if(!this.gestureChange){this.gestureChange=function(e){if(startScale!==undefined&&startZoom!==undefined){var scaleFactor=e.scale/startScale;var zoomFactor=Math.log(scaleFactor)/Math.log(2);zoomFactor=Math.round(zoomFactor);if(zoomFactor!=0&&startCenter){var currentZoom=map.zoom();var targetZoom=startZoom+zoomFactor;map.zoomBy(targetZoom-currentZoom,startCenter);}}
return cancelEvent(e);}}
return this.gestureChange;}
function getGestureEnd(){if(!this.gestureEnd){this.gestureEnd=function(e){removeEvent(container,'gesturechange',getGestureChange());removeEvent(container,'touchmove',getGestureCenter());removeEvent(container,'gestureend',getGestureEnd());startCenter=null;startScale=undefined;startZoom=undefined;return cancelEvent(e);}}
return this.gestureEnd;}
function getTouchStart(){if(!this.touchStartHandler){this.touchStartHandler=function(e){if(e.touches.length==1){addEvent(document,'touchcancel',getTouchEnd());addEvent(document,'touchend',getTouchEnd());addEvent(document,'touchmove',getTouchMove());prevTouch={x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY};}
return cancelEvent(e);};}
return this.touchStartHandler;}
function getTouchMove(){if(!this.touchMoveHandler){this.touchMoveHandler=function(e){if(prevTouch&&e.touches.length==1){map.panBy({x:e.touches[0].pageX-prevTouch.x,y:e.touches[0].pageY-prevTouch.y});prevTouch.x=e.touches[0].pageX;prevTouch.y=e.touches[0].pageY;}
return cancelEvent(e);};}
return this.touchMoveHandler;}
function getTouchEnd(){if(!this.touchEndHandler){this.touchEndHandler=function(e){if(prevTouch&&e.touches.length==0){removeEvent(document,'touchend',getTouchEnd());removeEvent(document,'touchcancel',getTouchEnd());removeEvent(document,'touchmove',getTouchMove());prevTouch=null;}
return cancelEvent(e);};}
return this.touchEndHandler;}
function getDoubleTap(){if(!this.doubleTapHandler){var prevPoint=null,prevTime=0;function distsq(t1,t2){return Math.sqrt(Math.pow(t1.x-t2.x,2)+Math.pow(t1.y-t2.y,2));}
this.doubleTapHandler=function(e){if(e.touches.length==1){var point={x:e.touches[0].pageX,y:e.touches[0].pageY};if(prevPoint){var dist=distsq(prevPoint,point),dt=new Date().getTime()-prevTime;if(dist<50&&dt<200){var z=map.zoom();z=1-z+Math.floor(z);map.zoomBy(z,point);}}
prevPoint=point;prevTime=new Date().getTime();}};}
return this.doubleTapHandler;}
touch.map=function(x){if(!arguments.length)return map;if(map){removeEvent(container,'touchstart',getTouchStart());removeEvent(container,'touchstart',getDoubleTap());removeEvent(container,'gesturestart',getGestureStart());container=null;}
if(map=x){container=map.container();addEvent(container,'touchstart',getTouchStart());addEvent(container,'touchstart',getDoubleTap());addEvent(container,'gesturestart',getGestureStart());}
return touch;};return touch;}})(org.polymaps);